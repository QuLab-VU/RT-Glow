---
title: "RT-Glo Cytation 2020-09-17 analysis"
author: "Darren Tyson"
date: "10/5/2020"
output: html_notebook
---
#### Assembling cell count data from py-seg-processed images
Cell (nuclear) counts were obtained from images generated by Clayton Wandishin on Cytation 5 in HTS (VAPR) core (2020-09-17). Images were processed using `py-seg` on `ccsb-tempo` server as described in `ccsb-tempo:/home/darren/HTS_segmentation/2020-09-17_Cytation_processing.ipynb`

```{r Setup}
library(diprate)
```


```{r Load cell count data, eval=FALSE, include=FALSE}
d <- read.csv("../data/20200917_Cytation_data.csv", as.is=TRUE)
a <- read.csv('../data/H1048 Luminescence Raw/H1048_AZD-1152_RawLum.csv', as.is=TRUE, row.names = 1)
```

Add drug info from plate map and times from luminescence data.
```{r Add drug info, eval=FALSE, include=FALSE}
d <- addMapInfo(d,"../data/20200917_Cytation_platemap.tsv")
d$uid <- paste(d$plate_id,d$well,sep="_")
d$cell.count <- d$cell_count
d$time_i <- sapply(strsplit(d$file_name,'\\.tif'), "[[", 1)
d$time_i <- as.numeric(sapply(d$time_i, function(x) substr(x,nchar(x)-2,nchar(x))))
d$time <- a$TotHour[d$time_i]
```

Save complete data set (will not overwrite if already exists).
```{r Save complete dataset}
full_fn <- "../data/20200917_Cytation_data_with_drugs.csv"
if(!file.exists(full_fn)) write.csv(d, file=full_fn, row.names=FALSE)
```

Load complete data set (py-seg-quantified) and compare to Cell Profiler counts.
```{r}
d <- read.csv("../data/20200917_Cytation_data_with_drugs.csv", as.is=TRUE)
cp <- read.csv("../data/Cytation_data_20200917_cp_counts.csv", as.is=TRUE)
d$count_cp <- cp[match(d$file_name,cp$file_name),"cell.count"]
```

Compare count data between `py-seg` and CellProfiler.
```{r fig.height=4, fig.width=4}
plot(d$cell.count,d$count_cp, xlim=c(0,2000), ylim=c(0,2000), xlab="py-seg", ylab="CellProfiler")
```

Clearly, CellProfiler counts correlated strongly with counts obtained using `py-seg` but counts were much higher.  

Will relegate `py-seg` counts to a different column and replace `cell.count` with those from CellProfiler.

```{r eval=FALSE, include=FALSE}
d$cell.count.pyseg <- d$cell.count
d$cell.count <- d$count_cp
d$count_cp <- NULL
d$uid <- d$well
d$expt.date <- "2020-09-17"
o <- d[,c("expt.date","cell.line","time","uid","well",
          "cell.count","cell.count.pyseg","drug1","drug1.conc","drug1.units"
          )]
```
Save dataset with CellProfiler counts.
```{r}
if(!file.exists("../data/20200917_Cytation_dataset.csv")) 
    write.csv(o, file="../data/20200917_Cytation_dataset.csv", row.names=FALSE)
```

### Can start here
Code above is for data processing.  

#### Load full dataset 
(CellProfiler cell counts)  
Examine growth curves. 
```{r}
d <- read.csv("../data/20200917_Cytation_dataset.csv", as.is=TRUE)
```


```{r fig.height=6, fig.width=6}
o <- d[d$cell.line=="DMS53" & d$drug1=="Barasertib (AZD1152-H",]
invisible(plotGC(o$time,o$cell.count,o$well,o$drug1.conc, 
                 ylab="Population doublings",
                 main="DMS53 + barasertib"))
```

```{r fig.height=6, fig.width=6}
o <- d[d$cell.line=="DMS53" & d$drug1=="TAK-901",]
invisible(plotGC(o$time,o$cell.count,o$well,o$drug1.conc, 
                 ylab="Population doublings",
                 main="DMS53 + TAK-901"))
```


```{r fig.height=6, fig.width=6}
o <- d[d$cell.line=="NCIH1048" & d$drug1=="Barasertib (AZD1152-H",]
invisible(plotGC(o$time,o$cell.count,o$well,o$drug1.conc, 
                 ylab="Population doublings",
                 main="NCIH1048 + barasertib"))
```

```{r fig.height=6, fig.width=6}
o <- d[d$cell.line=="NCIH1048" & d$drug1=="TAK-901",]
invisible(plotGC(o$time,o$cell.count,o$well,o$drug1.conc, 
                 ylab="Population doublings",
                 main="NCIH1048 + TAK-901"))
```

